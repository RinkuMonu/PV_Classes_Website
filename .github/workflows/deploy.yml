name: Deploy Next.js (static export) to CWP

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install & Build (export)
        run: |
          npm ci --legacy-peer-deps
          npm run build    # runs: next build && next export (creates ./out)

      - name: Tar exported site
        run: tar -czvf out.tar.gz -C out .

      - name: Upload to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22527
          source: "out.tar.gz"
          target: "/home/pvclasse/"

      - name: Unpack & publish
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22527
          script: |
            set -e
            mkdir -p /home/pvclasse/_deploy_tmp
            tar -xzvf /home/pvclasse/out.tar.gz -C /home/pvclasse/_deploy_tmp
            rm -rf /home/pvclasse/public_html/*
            mv /home/pvclasse/_deploy_tmp/* /home/pvclasse/public_html/
            rmdir /home/pvclasse/_deploy_tmp
            rm /home/pvclasse/out.tar.gz
